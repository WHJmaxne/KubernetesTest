#!groovy
pipeline{
    agent any
    environment{
        IMAGE_HUB="whjmanxe"
        IMAGE_NAME="kubernetestest"
        TAG_1=sh(date "+%Y%m%d%H%M").trim()
        TAG_2=sh(git log -1 --pretty=format:"%h").trim()
        IMAGE_TAG="${TAG_1}_${TAG_2}"
    }
    stages{
        stage('docker build'){
            steps{
                echo "start docker build ${IMAGE_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker build -t ${IMAGE_HUB}/${IMAGE_NAME}:${IMAGE_TAG} -f KubernetesTest/Dockerfile ."
            }
        }
        stage('docker push'){
            steps{
                echo "start docker push ${IMAGE_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker push ${IMAGE_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }
        stage('clear none images'){
            steps{
                echo "start clear none images"
                sh "docker images | grep none | awk '{print $3}' | xargs docker rmi"
            }
        }
        stage('helm deploy'){
            steps{
                echo "start docker push ${IMAGE_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker push ${IMAGE_HUB}/${IMAGE_NAME}:${IMAGE_TAG}"
            }
        }
    }
}